
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>datalight.zenodo_metadata &#8212; DataLight  documentation</title>
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">DataLight  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for datalight.zenodo_metadata</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>

<span class="sd">&quot;&quot;&quot;This module is implementing high level function to upload</span>
<span class="sd">and download Lightform data.</span>


<span class="sd">.. note::</span>
<span class="sd">    There are no verification of the validity of the schema used to validate</span>
<span class="sd">    the metadata which will be uploaded to Zenodo.</span>
<span class="sd">    This part should be done somewhere else. In a perfect world, the schema</span>
<span class="sd">    should be provided by Zenodo but it is not (yet) the case.</span>


<span class="sd">:Authors: Nicolas Gruel &lt;nicolas.gruel@manchester.ac.uk&gt;</span>

<span class="sd">:Copyright: IT Services, The University of Manchester</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># pylint: disable=locally-disabled, invalid-name</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.conf</span> <span class="k">import</span> <span class="n">logger</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">conf</span> <span class="k">import</span> <span class="n">logger</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">jsonschema</span>


<span class="n">_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>


<div class="viewcode-block" id="ZenodoMetadataException"><a class="viewcode-back" href="../../datalight.html#datalight.zenodo_metadata.ZenodoMetadataException">[docs]</a><span class="k">class</span> <span class="nc">ZenodoMetadataException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class for exception</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<span class="n">ZENODO_VALID_PROPERTIES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;publication_date&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;creators&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;doi&#39;</span><span class="p">,</span> <span class="s1">&#39;preserved_doi&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;keywords&#39;</span><span class="p">,</span> <span class="s1">&#39;notes&#39;</span><span class="p">,</span> <span class="s1">&#39;related_identifiers&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;relation&#39;</span><span class="p">,</span> <span class="s1">&#39;contributors&#39;</span><span class="p">,</span> <span class="s1">&#39;references&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;communities&#39;</span><span class="p">,</span> <span class="s1">&#39;grants&#39;</span><span class="p">,</span> <span class="s1">&#39;journal_title&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;journal_volume&#39;</span><span class="p">,</span> <span class="s1">&#39;journal_issue&#39;</span><span class="p">,</span> <span class="s1">&#39;journal_pages&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;conference_title&#39;</span><span class="p">,</span> <span class="s1">&#39;conference_acronym&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;conference_dates&#39;</span><span class="p">,</span> <span class="s1">&#39;conference_place&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;conference_url&#39;</span><span class="p">,</span> <span class="s1">&#39;conference_session&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;conference_session_part&#39;</span><span class="p">,</span> <span class="s1">&#39;imprint_publisher&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;imprint_isbn&#39;</span><span class="p">,</span> <span class="s1">&#39;partof_title&#39;</span><span class="p">,</span> <span class="s1">&#39;partof_pages&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;thesis_supervisors&#39;</span><span class="p">,</span> <span class="s1">&#39;thesis_university&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;subjects&#39;</span><span class="p">,</span> <span class="s1">&#39;version&#39;</span><span class="p">,</span> <span class="s1">&#39;language&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;affiliation&#39;</span><span class="p">,</span> <span class="s1">&#39;orcid&#39;</span><span class="p">,</span> <span class="s1">&#39;gnd&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;upload_type&#39;</span><span class="p">,</span> <span class="s1">&#39;publication_type&#39;</span><span class="p">,</span> <span class="s1">&#39;image_type&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;access_right&#39;</span><span class="p">,</span> <span class="s1">&#39;license&#39;</span><span class="p">,</span> <span class="s1">&#39;embargo_date&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;access_conditions&#39;</span>
                           <span class="p">]</span>


<span class="c1"># Define the path where the schema file for zenodo is written</span>
<span class="c1"># at installation time</span>
<span class="n">SCHEMAFILE</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_dir</span><span class="p">,</span> <span class="s1">&#39;schemas&#39;</span><span class="p">,</span> <span class="s1">&#39;zenodo&#39;</span><span class="p">,</span> <span class="s1">&#39;record-1.0.0.yml&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="ZenodoMetadata"><a class="viewcode-back" href="../../datalight.html#datalight.zenodo_metadata.ZenodoMetadata">[docs]</a><span class="k">class</span> <span class="nc">ZenodoMetadata</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class to manage the Metadata needed for Zenodo.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">SCHEMAFILE</span><span class="p">):</span>
        <span class="c1"># Read the metadata zenodo file to verify</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>

        <span class="c1"># Read the Zenodo yaml schema</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_schema</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>

<div class="viewcode-block" id="ZenodoMetadata.set_schema"><a class="viewcode-back" href="../../datalight.html#datalight.zenodo_metadata.ZenodoMetadata.set_schema">[docs]</a>    <span class="k">def</span> <span class="nf">set_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Schema file use: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">schema</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_schema</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Schema provided through dictionary object&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span> <span class="o">=</span> <span class="n">schema</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Something is wrong with the schema: </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ZenodoMetadataException</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div>

<div class="viewcode-block" id="ZenodoMetadata.set_metadata"><a class="viewcode-back" href="../../datalight.html#datalight.zenodo_metadata.ZenodoMetadata.set_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">set_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to set metadata from a file or a dictionary.</span>

<span class="sd">        Parameter</span>
<span class="sd">        ---------</span>
<span class="sd">        metadata: str, dict</span>
<span class="sd">            - if it is a string it is the name of file which contains</span>
<span class="sd">              zenodo metadata (yaml format). It will read the metadata</span>
<span class="sd">              and set the attribute _metadata to it</span>
<span class="sd">            - if dictionary, it set the attribute _metadata to it</span>

<span class="sd">        Attribute</span>
<span class="sd">        ---------</span>
<span class="sd">        _metadata: dict</span>
<span class="sd">            dictionary which contains Zenodo metadata</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Metadata provided by file: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">metadata</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_metadata</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Metadata provided by dictionary.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="n">metadata</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Metadata are empty&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="n">metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_minimal</span><span class="p">()</span></div>

<div class="viewcode-block" id="ZenodoMetadata.get_metadata"><a class="viewcode-back" href="../../datalight.html#datalight.zenodo_metadata.ZenodoMetadata.get_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">get_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method which will return Zenodo metadata</span>

<span class="sd">        This method will return a dictionary which contains Zenodo metadata.</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        metadata: dict</span>
<span class="sd">            Dictionary which contains Zenodo metadata.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_read_schema</span><span class="p">(</span><span class="n">fschema</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to read the schema.</span>

<span class="sd">        Parameter</span>
<span class="sd">        ---------</span>
<span class="sd">        schema: str</span>
<span class="sd">            Name of the file which contain the definition of the schema</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        _schema: dict</span>
<span class="sd">            dictionary which contains the schema used to validate the metadata.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Read schema from: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fschema</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fschema</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">_schema</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Schema file not founded.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fschema</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ZenodoMetadataException</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_schema</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_read_metadata</span><span class="p">(</span><span class="n">fmetadata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to read Zenodo metadata file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Read metadata from: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fmetadata</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fmetadata</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">_metadata</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Metadata file not founded.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fmetadata</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ZenodoMetadataException</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="c1"># change communities identifier in lower case (only format accepted by zenodo)</span>
        <span class="k">if</span> <span class="s1">&#39;communities&#39;</span> <span class="ow">in</span> <span class="n">_metadata</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_com</span> <span class="ow">in</span> <span class="n">_metadata</span><span class="p">[</span><span class="s1">&#39;communities&#39;</span><span class="p">]:</span>
                <span class="n">_com</span><span class="p">[</span><span class="s1">&#39;identifier&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_com</span><span class="p">[</span><span class="s1">&#39;identifier&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">_metadata</span>

    <span class="k">def</span> <span class="nf">_check_minimal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to check that the minimal set of Metadata needed for Zenodo</span>
<span class="sd">        is present</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Metadata not provided&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ZenodoMetadataException</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="n">minimal_keys</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;upload_type&#39;</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;creators&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">minimal_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Missing metadata information: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">ZenodoMetadataException</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;access_right&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">[</span><span class="s1">&#39;access_right&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;open&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Add metadata: &quot;access_right&quot; set to default value &#39;</span>
                           <span class="s1">&#39;&quot;open&quot;&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;license&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">[</span><span class="s1">&#39;license&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;cc-by-4.0&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Add metadata: &quot;license&quot; set to default value &#39;</span>
                           <span class="s1">&#39;&quot;cc-by-4.0&quot;&#39;</span><span class="p">)</span>

        <span class="c1"># Default value.(Should be done in schema)</span>
        <span class="c1">#TODO</span>

        <span class="k">return</span> <span class="kc">True</span>

<div class="viewcode-block" id="ZenodoMetadata.validate"><a class="viewcode-back" href="../../datalight.html#datalight.zenodo_metadata.ZenodoMetadata.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method which is verifying that the metadata does have the correct type</span>
<span class="sd">        and if the dependencies are respected.</span>

<span class="sd">        The dependencies have to be check because the value of a</span>
<span class="sd">        metadata can implied the presence of another one. For example,</span>
<span class="sd">        if *upload_type* (which is a necessary metadata) has the value</span>
<span class="sd">        *publication* that implied the presence of the metadata</span>
<span class="sd">        *publication_type*.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Check if the minimal set of information are provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_minimal</span><span class="p">()</span>

        <span class="c1"># Check validity of the license (if open or embargoed)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_license_availability</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">jsonschema</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">jsonschema</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ValidationError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;ValidationError: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ZenodoMetadataException</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Metadata should be ok to use for upload&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_check_license_availability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flicenses</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">opendefinition</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to verify the license</span>

<span class="sd">        Zenodo metadata des have an non-optional keyword *access_right*,</span>
<span class="sd">        that if it is set to open or embargoed an optional keyword</span>
<span class="sd">        **can** be added: license.</span>
<span class="sd">        The license in this case has to be considered as open by Zenodo and</span>
<span class="sd">        be part of the list provided by the</span>
<span class="sd">        `Open Definition License Service&lt;https://licenses.opendefinition.org/&gt;`_</span>

<span class="sd">        The method will look directly on internet where the service is providing</span>
<span class="sd">        a json file which contains all the acceptable license:</span>

<span class="sd">        https://licenses.opendefinition.org/licenses/groups/all.json</span>

<span class="sd">        This file is also provided by the software to be able to verify</span>
<span class="sd">        the validity of the license.</span>

<span class="sd">        .. important::</span>
<span class="sd">            The file provided by the software **could** be out-dated.</span>
<span class="sd">            Since the upload of the data on Zenodo will do the verification</span>
<span class="sd">            it is not a major problem but the user as to be careful.</span>

<span class="sd">        Parameter</span>
<span class="sd">        ---------</span>

<span class="sd">        update: boolean</span>
<span class="sd">            if True will update the license file</span>
<span class="sd">            TODO: NOT IMPLEMENTED YET</span>

<span class="sd">        Exception</span>
<span class="sd">        ---------</span>
<span class="sd">        raise exception if license does not exist in the list accepted by Zenodo</span>
<span class="sd">        as open.</span>


<span class="sd">        TODO: modify method to use file on disk before and if license not there,</span>
<span class="sd">        TODO: look at the file on internet and retest it.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># if access right is not &#39;open&#39; or &#39;embargoed&#39; there are no need to</span>
        <span class="c1"># test if the license is open compliant with Zenodo</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">[</span><span class="s1">&#39;access_right&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="s1">&#39;embargoed&#39;</span><span class="p">]):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No need to check license for Zenodo upload.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># Get on the opendefinition website the file with the licenses</span>
        <span class="c1"># informations</span>
        <span class="k">if</span> <span class="n">opendefinition</span><span class="p">:</span>
            <span class="n">licenses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_opendefinition_file</span><span class="p">()</span>

        <span class="c1"># Get the licenses information from an input file or</span>
        <span class="c1"># from the default file</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">flicenses</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">flicenses</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_dir</span><span class="p">,</span> <span class="s1">&#39;schemas&#39;</span><span class="p">,</span> <span class="s1">&#39;zenodo&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;opendefinition-licenses.json&#39;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">flicenses</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">licenses</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s1">&#39;Use file: </span><span class="si">{}</span><span class="s1"> to validate license&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flicenses</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="n">licenses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_opendefinition_file</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;license&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">[</span><span class="s1">&#39;access_right&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="s1">&#39;embargoed&#39;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">[</span><span class="s1">&#39;license&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">[</span><span class="s1">&#39;license&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="n">mlicense</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">[</span><span class="s1">&#39;license&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;License present in metadata file: &#39;</span>
                        <span class="s1">&#39;&quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mlicense</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;access_right: &#39;</span>
                        <span class="s1">&#39;&quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">[</span><span class="s1">&#39;access_right&#39;</span><span class="p">]))</span>

            <span class="n">_tmp</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">lic</span> <span class="ow">in</span> <span class="n">licenses</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">lic</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">mlicense</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;license: &quot;</span><span class="si">{}</span><span class="s1">&quot; validated.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lic</span><span class="p">))</span>
                    <span class="k">return</span> <span class="kc">True</span>

            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;license: &quot;</span><span class="si">{}</span><span class="s1">&quot; is not listed as &#39;</span> \
                      <span class="s1">&#39;open by Zenodo&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">[</span><span class="s1">&#39;license&#39;</span><span class="p">])</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ZenodoMetadataException</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_opendefinition_file</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;Method which download the definition file for open source licenses</span>
<span class="sd">        accepted by Zenodo.</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        licenses: dict</span>
<span class="sd">            a dictionnary which contains the informations the differents</span>
<span class="sd">            licenses.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://licenses.opendefinition.org/licenses/groups/all.json&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">licenses</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;open licenses file use for validation: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">urllib</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">URLError</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Not possible to access to the list &#39;</span> \
                      <span class="s1">&#39;(internet connection problem?): </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ZenodoMetadataException</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">licenses</span>

    <span class="k">def</span> <span class="nf">_remove_extra_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to remove properties which are not allowed by zenodo</span>

<span class="sd">        Jsonschema has a major limitation (it which does not allowed to use</span>
<span class="sd">        is in discussion to modify it in future iteration of the format).</span>
<span class="sd">        It does not allowed the usage of::</span>

<span class="sd">            additionalProperties: False</span>

<span class="sd">        when associated to combining schema.</span>

<span class="sd">        We are touching the problem describe as a</span>
<span class="sd">        `shortcoming &lt;https://spacetelescope.github.io/understanding-json-schema/reference/combining.html#combining&gt;`_</span>
<span class="sd">        that implied that we need to deal outside the json schema</span>
<span class="sd">        for verify that only Zenodo metadata are provided at the upload time.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">keytoremove</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ZENODO_VALID_PROPERTIES</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Zenodo metadata with &#39;</span>
                               <span class="s1">&#39;key invalid: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
                <span class="n">keytoremove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keytoremove</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Invalid key: </span><span class="si">{}</span><span class="s1"> removed.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span></div>


    <span class="c1"># def modify_metadata(self, metadata):</span>
    <span class="c1">#     &quot;&quot;&quot;Method to modify the metadata after having upload a file.</span>
    <span class="c1">#</span>
    <span class="c1">#     Metadata dictionary should contains at least the following keys:</span>
    <span class="c1">#     title: str</span>
    <span class="c1">#     upload_type: str [&#39;publication&#39;, &#39;poster&#39;, &#39;presentation&#39;, &#39;dataset&#39;,</span>
    <span class="c1">#                       &#39;image&#39;, video&#39;, &#39;software&#39;, &#39;lesson&#39;, &#39;other&#39;]</span>
    <span class="c1">#     &#39;description&#39;: str</span>
    <span class="c1">#     &#39;creators&#39;: list of dictionaries which contains name and affiliation</span>
    <span class="c1">#     e.g.:</span>
    <span class="c1">#     metadata = { &#39;metadata&#39;: { &#39;title&#39;: &#39;My first upload&#39;,</span>
    <span class="c1">#                                &#39;upload_type&#39;: &#39;poster&#39;,</span>
    <span class="c1">#                                &#39;description&#39;: &#39;This is my first upload&#39;,</span>
    <span class="c1">#                                &#39;creators&#39;: [{&#39;name&#39;: &#39;Doe, John&#39;,</span>
    <span class="c1">#                                              &#39;affiliation&#39;: &#39;Zenodo&#39;}]</span>
    <span class="c1">#                }</span>
    <span class="c1">#</span>
    <span class="c1">#     Parameters</span>
    <span class="c1">#     ----------</span>
    <span class="c1">#     metadata: dict,</span>
    <span class="c1">#         dictionary which will contains the zenodo metadata associated</span>
    <span class="c1">#         to the file(s) uploaded using the deposition id.</span>
    <span class="c1">#</span>
    <span class="c1">#     Return</span>
    <span class="c1">#     ------</span>
    <span class="c1">#     boolean</span>
    <span class="c1">#         return True if everything went well, false in other hand.</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#</span>
    <span class="c1">#     if metadata is not dict:</span>
    <span class="c1">#         logger.error(&#39;Metadata should be given in a dictionary form&#39;)</span>
    <span class="c1">#     pass</span>



<span class="c1"># license available for access_right: open from</span>
<span class="c1"># https://licenses.opendefinition.org</span>
<span class="c1">#</span>
<span class="c1"># A machine readable format is available at:</span>
<span class="c1">#</span>
<span class="c1"># https://licenses.opendefinition.org/licenses/groups/all.json</span>
<span class="c1"># format :</span>
<span class="c1"># {</span>
<span class="c1">#   &quot;id&quot;: &quot;ODC-BY-1.0&quot;,</span>
<span class="c1">#   &quot;domain_content&quot;: false,</span>
<span class="c1">#   &quot;domain_data&quot;: true,</span>
<span class="c1">#   &quot;domain_software&quot;: false,</span>
<span class="c1">#   &quot;od_conformance&quot;: &quot;approved&quot;,</span>
<span class="c1">#   &quot;osd_conformance&quot;: &quot;not reviewed&quot;,</span>
<span class="c1">#   &quot;status&quot;: &quot;active&quot;,</span>
<span class="c1">#   &quot;title&quot;: &quot;Open Data Commons Attribution License 1.0&quot;,</span>
<span class="c1">#   &quot;url&quot;: &quot;https://opendatacommons.org/licenses/by&quot;</span>
<span class="c1"># }</span>
<span class="c1"># How to read it:</span>
<span class="c1"># licenses = urllib.request.urlopen(&#39;https://licenses.opendefinition.org/licenses/groups/all.json&#39;)</span>
<span class="c1"># import json</span>
<span class="c1"># licenses = json.load(licenses)</span>
<span class="c1">#</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">DataLight  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2019, Peter Crowther.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.2.
    </div>
  </body>
</html>